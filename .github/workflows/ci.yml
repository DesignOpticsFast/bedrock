name: CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  build:                       # keep this id so the check stays "CI / build"
    name: Ubuntu build (with OpenCascade)
    runs-on: ubuntu-24.04
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            g++ \
            libtbb-dev

      - name: Print tool versions
        run: |
          echo "=== Tool Versions ==="
          g++ --version
          cmake --version
          ninja --version
          echo "===================="

      - name: Configure (CMake - engine-only build)
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DBEDROCK_WITH_OCCT=OFF

      - name: Build libraries only
        run: |
          cmake --build build --config Release --target bedrock_engine -j

      - name: Upload CMake logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cmake-logs
          path: |
            build/CMakeFiles/CMakeOutput.log
            build/CMakeFiles/CMakeError.log
          retention-days: 7

      - name: Post-job cleanup
        if: always()
        run: |
          rm -rf "$HOME/_work" || true

  tests:
    name: Tests (Unit + Integration)
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-14]
    runs-on: ${{ matrix.os }}
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    env:
      QT_VERSION: 6.10.1
      QTFRAMEWORK_BYPASS_LICENSE_CHECK: "1"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-24.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            g++ \
            libtbb-dev \
            libgtest-dev \
            libomp-dev \
            lcov

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-14'
        run: |
          brew install cmake ninja libomp

      - name: Print tool versions
        run: |
          echo "=== Tool Versions ==="
          if [[ "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
            g++ --version
          else
            clang++ --version
          fi
          cmake --version
          ninja --version
          echo "===================="

      - name: Install Qt 6.10.1
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.10.1'
          modules: 'qtbase qttools qttranslations'
          cache: true

      - name: Setup Qt environment
        run: |
          if [[ -z "$Qt6_DIR" ]]; then
            echo "âŒ Qt6_DIR not set by install-qt-action"
            exit 1
          fi
          CMAKE_PREFIX_PATH=$(dirname "$Qt6_DIR")
          echo "CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH" >> $GITHUB_ENV
          echo "Using CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH"

      - name: Configure (CMake - with transport deps)
        run: |
          # Enable coverage on Linux only
          if [[ "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
            COVERAGE_FLAGS="-fprofile-arcs -ftest-coverage --coverage"
            BUILD_TYPE="RelWithDebInfo"
          else
            COVERAGE_FLAGS=""
            BUILD_TYPE="Release"
          fi
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DBEDROCK_WITH_OCCT=OFF \
            -DBEDROCK_WITH_TRANSPORT_DEPS=ON \
            -DCMAKE_PREFIX_PATH="$CMAKE_PREFIX_PATH" \
            -DCMAKE_CXX_FLAGS="$COVERAGE_FLAGS" \
            -DCMAKE_EXE_LINKER_FLAGS="$COVERAGE_FLAGS" \
            -DBUILD_TESTING=ON

      - name: Build all tests
        run: |
          # Use appropriate build type based on OS
          if [[ "${{ matrix.os }}" == "ubuntu-24.04" ]]; then
            BUILD_CONFIG="RelWithDebInfo"
          else
            BUILD_CONFIG="Release"
          fi
          cmake --build build --config "$BUILD_CONFIG" -j

      - name: Run all tests (ctest)
        run: |
          cd build
          ctest --output-on-failure

      - name: Generate coverage report (Linux only)
        if: matrix.os == 'ubuntu-24.04'
        run: |
          cd build
          # Capture coverage data
          lcov --directory . --capture --output-file coverage.info
          
          # Remove system headers, external libs, and test files
          lcov --remove coverage.info \
            '/usr/*' \
            '*/tests/*' \
            '*/googletest/*' \
            '*/generated/*' \
            '*/build/*' \
            --output-file coverage-filtered.info
          
          # Generate HTML report (focus on src/palantir/*)
          genhtml coverage-filtered.info \
            --output-directory coverage-html \
            --prefix "$(pwd)/.." \
            --show-details \
            --legend \
            --demangle-cpp
          
          # Print summary
          echo "=== Coverage Summary ==="
          lcov --summary coverage-filtered.info || true

      - name: Upload coverage report (Linux only)
        if: matrix.os == 'ubuntu-24.04'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-bedrock
          path: |
            build/coverage-html/**
            build/coverage-filtered.info
          retention-days: 30

      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.os }}
          path: |
            build/Testing/**/*.xml
            build/Testing/**/*.log
          retention-days: 7
